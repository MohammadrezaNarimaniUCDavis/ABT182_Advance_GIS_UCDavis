name: Cancel Stuck GitHub Pages Deployment

on:
  workflow_dispatch:

permissions:
  pages: write
  contents: read

jobs:
  cancel-deployment:
    runs-on: ubuntu-latest
    steps:
      - name: Cancel stuck deployments
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              // Get repository info
              const owner = context.repo.owner;
              const repo = context.repo.repo;
              
              console.log(`Checking for stuck deployments in ${owner}/${repo}...`);
              
              // Try to get Pages deployments via REST API
              // Note: GitHub Pages API might be limited, so we'll try multiple approaches
              
              // Approach 1: Try to cancel via Pages API (if available)
              try {
                const response = await github.request('GET /repos/{owner}/{repo}/pages/deployments', {
                  owner: owner,
                  repo: repo,
                });
                
                console.log('Found deployments:', JSON.stringify(response.data, null, 2));
                
                if (response.data && Array.isArray(response.data)) {
                  for (const deployment of response.data) {
                    if (deployment.status === 'in_progress' || deployment.status === 'queued') {
                      console.log(`Found stuck deployment: ${deployment.id} (status: ${deployment.status})`);
                      console.log(`Commit: ${deployment.pages_build_version}`);
                      
                      // Try to cancel it
                      try {
                        await github.request('POST /repos/{owner}/{repo}/pages/deployments/{pages_deployment_id}/cancel', {
                          owner: owner,
                          repo: repo,
                          pages_deployment_id: deployment.id,
                        });
                        console.log(`✅ Successfully cancelled deployment ${deployment.id}`);
                      } catch (cancelError) {
                        console.log(`⚠️ Could not cancel deployment ${deployment.id}: ${cancelError.message}`);
                      }
                    }
                  }
                }
              } catch (apiError) {
                console.log(`⚠️ Could not access Pages API: ${apiError.message}`);
                console.log('This might be because the API endpoint is not available or requires different permissions.');
              }
              
              // Approach 2: Check workflow runs and cancel them
              const workflows = await github.rest.actions.listWorkflowRunsForRepo({
                owner: owner,
                repo: repo,
                workflow_id: 'deploy.yml',
                status: 'in_progress',
                per_page: 10,
              });
              
              console.log(`Found ${workflows.data.workflow_runs.length} in-progress workflow runs`);
              
              for (const run of workflows.data.workflow_runs) {
                console.log(`Found in-progress workflow run: ${run.id} (commit: ${run.head_sha.substring(0, 7)})`);
                
                // Cancel the workflow run
                try {
                  await github.rest.actions.cancelWorkflowRun({
                    owner: owner,
                    repo: repo,
                    run_id: run.id,
                  });
                  console.log(`✅ Successfully cancelled workflow run ${run.id}`);
                } catch (cancelError) {
                  console.log(`⚠️ Could not cancel workflow run ${run.id}: ${cancelError.message}`);
                }
              }
              
              console.log('✅ Cancellation process completed');
            } catch (error) {
              console.error('❌ Error:', error.message);
              core.setFailed(`Failed to cancel deployments: ${error.message}`);
            }
